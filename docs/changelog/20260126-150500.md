# F2 Douyin 模块重写进度

## 任务描述
将 Python 项目 [Johnserf-Seed/f2](https://github.com/Johnserf-Seed/f2) 的 douyin 模块重写为 Node.js/TypeScript。

## 已完成文件对照表

| Python 源文件 | TypeScript 目标文件 | 状态 |
|--------------|-------------------|------|
| `f2/apps/douyin/api.py` (DouyinAPIEndpoints) | `src/api/endpoints.ts` | ✅ 完成 |
| `f2/utils/xbogus.py` | `src/algorithm/xbogus.ts` | ✅ 完成 |
| `f2/utils/abogus.py` | `src/algorithm/abogus.ts` | ✅ 完成 |
| `f2/apps/douyin/model.py` | `src/model/request.ts` | ✅ 完成 |
| `f2/apps/douyin/utils.py` | 多个文件（见下方） | ✅ 完成 |
| `f2/apps/douyin/filter.py` | `src/filter/*.ts` | ✅ 完成 |
| `f2/utils/json_filter.py` | `src/filter/base.ts` | ✅ 完成 |
| `f2/apps/douyin/crawler.py` | `src/crawler/douyin.ts` | ✅ 完成 |
| `f2/apps/douyin/handler.py` | `src/handler/*.ts` | ✅ 完成 |
| `f2/apps/douyin/dl.py` | `src/downloader/*.ts` | ✅ 完成 |

## utils.py 拆分详情

| Python 类/函数 | TypeScript 文件 | 说明 |
|---------------|----------------|------|
| `ClientConfManager` | `src/config/index.ts` | 配置管理 |
| `TokenManager` | `src/utils/token.ts` | msToken/ttwid/webid 生成 |
| `VerifyFpManager` | `src/utils/verify.ts` | verifyFp 生成 |
| `XBogusManager` | `src/utils/sign.ts` | X-Bogus 签名 |
| `ABogusManager` | `src/utils/sign.ts` | A-Bogus 签名 |
| `SecUserIdFetcher` | `src/utils/fetcher.ts` | sec_user_id 提取 |
| `AwemeIdFetcher` | `src/utils/fetcher.ts` | aweme_id 提取 |
| `MixIdFetcher` | `src/utils/fetcher.ts` | mix_id 提取 |
| `WebCastIdFetcher` | `src/utils/fetcher.ts` | webcast_id/room_id 提取 |
| `format_file_name` | `src/utils/file.ts` | 文件名格式化 |
| `create_user_folder` | `src/utils/file.ts` | 用户目录创建 |
| `json_2_lrc` | `src/utils/file.ts` | 歌词格式转换 |
| API异常类 | `src/errors/index.ts` | 错误处理 |
| HTTP客户端 (BaseCrawler) | `src/client/http.ts` | HTTP 请求封装 |
| 通用工具函数 | `src/utils/common.ts` | 随机字符串、URL提取等 |

## filter.py 拆分详情

| Python 类 | TypeScript 文件 | 说明 |
|----------|----------------|------|
| `JSONModel` | `src/filter/base.ts` | JSONPath 数据提取基类 |
| `_filter_utils` | `src/filter/utils.ts` | replaceT, timestamp2Str, filterToList |
| `UserProfileFilter` | `src/filter/user.ts` | 用户资料过滤 |
| `UserFollowingFilter` | `src/filter/user.ts` | 关注列表过滤 |
| `UserFollowerFilter` | `src/filter/user.ts` | 粉丝列表过滤 |
| `QueryUserFilter` | `src/filter/user.ts` | 用户查询过滤 |
| `UserPostFilter` | `src/filter/post.ts` | 用户作品过滤 |
| `UserCollectionFilter` | `src/filter/post.ts` | 收藏夹作品过滤 |
| `UserMixFilter` | `src/filter/post.ts` | 合集作品过滤 |
| `UserLikeFilter` | `src/filter/post.ts` | 喜欢列表过滤 |
| `PostRelatedFilter` | `src/filter/post.ts` | 相关作品过滤 |
| `UserCollectsFilter` | `src/filter/post.ts` | 收藏夹列表过滤 |
| `UserMusicCollectionFilter` | `src/filter/post.ts` | 音乐收藏过滤 |
| `PostDetailFilter` | `src/filter/post.ts` | 作品详情过滤 |
| `PostStatsFilter` | `src/filter/post.ts` | 作品统计过滤 |
| `PostCommentFilter` | `src/filter/comment.ts` | 评论过滤 |
| `PostCommentReplyFilter` | `src/filter/comment.ts` | 评论回复过滤 |
| `UserLiveFilter` | `src/filter/live.ts` | 用户直播过滤 |
| `UserLive2Filter` | `src/filter/live.ts` | 用户直播过滤(v2) |
| `UserLiveStatusFilter` | `src/filter/live.ts` | 直播状态过滤 |
| `FollowingUserLiveFilter` | `src/filter/live.ts` | 关注用户直播过滤 |
| `LiveImFetchFilter` | `src/filter/live.ts` | 直播消息过滤 |
| `FriendFeedFilter` | `src/filter/feed.ts` | 好友动态过滤 |
| `HomePostSearchFilter` | `src/filter/search.ts` | 首页搜索过滤 |
| `SuggestWordFilter` | `src/filter/search.ts` | 搜索建议词过滤 |

## crawler.py 重写详情

| Python 类/方法 | TypeScript 文件/方法 | 说明 |
|---------------|---------------------|------|
| `DouyinCrawler` | `src/crawler/douyin.ts` | API 请求封装 |
| `fetchUserProfile` | `DouyinCrawler.fetchUserProfile` | 获取用户资料 |
| `fetchUserPost` | `DouyinCrawler.fetchUserPost` | 获取用户作品 |
| `fetchUserLike` | `DouyinCrawler.fetchUserLike` | 获取用户喜欢 |
| `fetchUserCollection` | `DouyinCrawler.fetchUserCollection` | 获取用户收藏 |
| `fetchUserCollects` | `DouyinCrawler.fetchUserCollects` | 获取收藏夹列表 |
| `fetchUserCollectsVideo` | `DouyinCrawler.fetchUserCollectsVideo` | 获取收藏夹作品 |
| `fetchUserMusicCollection` | `DouyinCrawler.fetchUserMusicCollection` | 获取音乐收藏 |
| `fetchUserMix` | `DouyinCrawler.fetchUserMix` | 获取合集作品 |
| `fetchFriendFeed` | `DouyinCrawler.fetchFriendFeed` | 获取朋友作品 |
| `fetchPostFeed` | `DouyinCrawler.fetchPostFeed` | 获取首页 Feed |
| `fetchFollowFeed` | `DouyinCrawler.fetchFollowFeed` | 获取关注作品 |
| `fetchPostRelated` | `DouyinCrawler.fetchPostRelated` | 获取相关推荐 |
| `fetchPostDetail` | `DouyinCrawler.fetchPostDetail` | 获取作品详情 |
| `fetchPostComment` | `DouyinCrawler.fetchPostComment` | 获取作品评论 |
| `fetchPostCommentReply` | `DouyinCrawler.fetchPostCommentReply` | 获取评论回复 |
| `fetchUserLive` | `DouyinCrawler.fetchUserLive` | 获取直播信息 |
| `fetchUserLive2` | `DouyinCrawler.fetchUserLive2` | 获取直播信息2 |
| `fetchFollowingUserLive` | `DouyinCrawler.fetchFollowingUserLive` | 获取关注直播 |
| `fetchLiveImFetch` | `DouyinCrawler.fetchLiveImFetch` | 获取直播弹幕 |
| `fetchUserLiveStatus` | `DouyinCrawler.fetchUserLiveStatus` | 获取直播状态 |
| `fetchSuggestWords` | `DouyinCrawler.fetchSuggestWords` | 获取搜索建议 |
| `fetchPostSearch` | `DouyinCrawler.fetchPostSearch` | 搜索作品 |
| `fetchHomePostSearch` | `DouyinCrawler.fetchHomePostSearch` | 主页搜索 |
| `fetchUserFollowing` | `DouyinCrawler.fetchUserFollowing` | 获取关注列表 |
| `fetchUserFollower` | `DouyinCrawler.fetchUserFollower` | 获取粉丝列表 |
| `fetchQueryUser` | `DouyinCrawler.fetchQueryUser` | 查询用户 |
| `fetchPostStats` | `DouyinCrawler.fetchPostStats` | 获取作品统计 |

## handler.py 重写详情

| Python 类/方法 | TypeScript 文件/方法 | 说明 |
|---------------|---------------------|------|
| `DouyinHandler` | `src/handler/index.ts` | 业务逻辑处理 |
| `@mode_handler` | `src/handler/mode.ts` | 模式处理装饰器 |
| `fetchUserProfile` | `DouyinHandler.fetchUserProfile` | 获取用户资料 |
| `fetchOneVideo` | `DouyinHandler.fetchOneVideo` | 获取单个作品 |
| `fetchUserPostVideos` | `DouyinHandler.fetchUserPostVideos` | 获取用户作品(生成器) |
| `fetchUserLikeVideos` | `DouyinHandler.fetchUserLikeVideos` | 获取用户喜欢(生成器) |
| `fetchUserCollectionVideos` | `DouyinHandler.fetchUserCollectionVideos` | 获取用户收藏(生成器) |
| `fetchUserCollects` | `DouyinHandler.fetchUserCollects` | 获取收藏夹(生成器) |
| `fetchUserCollectsVideos` | `DouyinHandler.fetchUserCollectsVideos` | 获取收藏夹作品(生成器) |
| `fetchUserMixVideos` | `DouyinHandler.fetchUserMixVideos` | 获取合集作品(生成器) |
| `fetchUserMusicCollection` | `DouyinHandler.fetchUserMusicCollection` | 获取音乐收藏(生成器) |
| `fetchRelatedVideos` | `DouyinHandler.fetchRelatedVideos` | 获取相关推荐(生成器) |
| `fetchFriendFeedVideos` | `DouyinHandler.fetchFriendFeedVideos` | 获取朋友作品(生成器) |
| `fetchUserLiveVideos` | `DouyinHandler.fetchUserLiveVideos` | 获取直播信息 |
| `fetchPostComment` | `DouyinHandler.fetchPostComment` | 获取评论(生成器) |
| `fetchPostCommentReply` | `DouyinHandler.fetchPostCommentReply` | 获取评论回复(生成器) |
| `fetchHomePostSearch` | `DouyinHandler.fetchHomePostSearch` | 主页搜索(生成器) |
| `fetchUserFollowing` | `DouyinHandler.fetchUserFollowing` | 获取关注列表(生成器) |
| `fetchUserFollower` | `DouyinHandler.fetchUserFollower` | 获取粉丝列表(生成器) |

## dl.py (下载器) 重写详情

| Python 类/方法 | TypeScript 文件/方法 | 说明 |
|---------------|---------------------|------|
| `DouyinDownloader` | `src/downloader/douyin.ts` | 下载器主类 |
| `createDownloadTasks` | `DouyinDownloader.createDownloadTasks` | 创建作品下载任务 |
| `handleDownload` | `DouyinDownloader.handleDownload` | 处理单个作品下载 |
| `downloadVideo` | `DouyinDownloader.downloadVideo` | 下载视频 |
| `downloadImages` | `DouyinDownloader.downloadImages` | 下载图集 |
| `downloadMusic` | `DouyinDownloader.downloadMusic` | 下载音乐 |
| `downloadCover` | `DouyinDownloader.downloadCover` | 下载封面 |
| `downloadDesc` | `DouyinDownloader.downloadDesc` | 保存文案 |
| `createMusicDownloadTasks` | `DouyinDownloader.createMusicDownloadTasks` | 创建音乐下载任务 |
| `createStreamTasks` | `DouyinDownloader.createStreamTasks` | 创建直播流下载任务 |
| `downloadFile` | `DouyinDownloader.downloadFile` | 文件下载核心方法 |

### 下载器类型定义 (src/downloader/types.ts)

| 类型 | 说明 |
|-----|------|
| `DownloadConfig` | 下载配置 (cookie, path, concurrency, naming 等) |
| `AwemeData` | 作品数据结构 (视频/图集/音乐地址等) |
| `MusicData` | 音乐数据结构 |
| `WebcastData` | 直播数据结构 |
| `DownloadResult` | 下载结果 (success, filePath, error) |
| `DownloadProgress` | 下载进度 (downloaded, total, percentage, speed) |
| `ProgressCallback` | 进度回调函数类型 |

## 测试脚本

| 文件 | 说明 |
|------|------|
| `examples/test-user-profile.ts` | 用户信息解析测试脚本 |
| `examples/test-download.ts` | 作品下载测试脚本 |

使用方法:
```bash
# 测试用户信息解析
npx tsx examples/test-user-profile.ts "<用户链接>"

# 测试作品下载
npx tsx examples/test-download.ts "<作品链接>"
```

## CLI 命令

```bash
# 下载单个作品
dy download <url> -c "<cookie>" -o ./downloads --cover --music --desc

# 下载用户主页作品
dy user <url> -c "<cookie>" -o ./downloads -n 10 --cover --music --desc
```

| 选项 | 说明 |
|------|------|
| `-o, --output <path>` | 下载目录 (默认: ./downloads) |
| `-c, --cookie <cookie>` | Cookie (必需) |
| `-n, --number <count>` | 下载数量，0表示全部 (仅 user 命令) |
| `--cover` | 下载封面 |
| `--music` | 下载音乐 |
| `--desc` | 下载文案 |

## 重要修复

1. **签名算法**: 默认使用 X-Bogus (A-Bogus 目前返回空响应)
2. **HTTP Headers**: 添加必要的请求头 (Accept, Origin, Sec-* 等)
3. **类型导出**: 修复 ESM 模块类型导出 (`export type` for interfaces)

## 待完成文件

| Python 源文件 | 说明 |
|--------------|------|
| `f2/apps/douyin/crawler.py` (WebSocket部分) | 直播弹幕 WebSocket |

## 项目结构

```
examples/
├── test-user-profile.ts  # 用户信息解析测试
└── test-download.ts      # 作品下载测试

src/
├── algorithm/
│   ├── index.ts
│   ├── xbogus.ts
│   └── abogus.ts
├── api/
│   ├── index.ts
│   ├── client.ts
│   └── endpoints.ts
├── client/
│   └── http.ts
├── config/
│   └── index.ts
├── cli/
│   └── index.ts           # CLI 入口
├── crawler/
│   ├── index.ts
│   └── douyin.ts          # DouyinCrawler 类
├── downloader/
│   ├── index.ts
│   ├── types.ts           # 下载器类型定义
│   └── douyin.ts          # DouyinDownloader 类
├── errors/
│   └── index.ts
├── filter/
│   ├── index.ts
│   ├── base.ts
│   ├── utils.ts
│   ├── user.ts
│   ├── post.ts
│   ├── comment.ts
│   ├── live.ts
│   ├── feed.ts
│   └── search.ts
├── handler/
│   ├── index.ts           # DouyinHandler 类
│   ├── types.ts           # Handler 类型定义
│   └── mode.ts            # 模式处理器
├── model/
│   ├── request.ts
│   └── types.ts
└── utils/
    ├── index.ts
    ├── common.ts
    ├── fetcher.ts
    ├── file.ts
    ├── sign.ts
    ├── token.ts
    ├── url-parser.ts
    └── verify.ts
```
